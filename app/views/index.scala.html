@(headerImageUrl: String, posts: Seq[Post], blogsPerPage: Int)(implicit request: Request[AnyContent])
@import org.joda.time.{DateTime, DateTimeZone}
<script>
    function imgError(image) {
        image.onerror = "";
        image.src = "@headerImageUrl";
        return true;
    }
</script>

@displayPost(post: Post) = {
    <a class="post" href="@post.slug">
        <div class="post__cover">
            <img src="@post.mainImage" onerror="imgError(this)" alt="" />
        </div>
        <div class="post__infos">
            <div class="flexbox">
                @if(post.author.nonEmpty) {
                    <img class="post__avatar" src="@post.author.map(_.avatar_url)" alt="author image" nopin="nopin">
                    <p class="post__author">@post.author.map(_.name.getOrElse(post.authorName)).getOrElse(post.authorName)<span></span>@post.publicationDate.toString("dd MMM yyyy")</p> 
                    <!-- <a class="post__author" href="@routes.HomeController.byAuthor(post.authorName)">@post.author.map(_.name.getOrElse(post.authorName)).getOrElse(post.authorName)</a> -->
                }
                @if(post.author.isEmpty) {
                    <img class="post__avatar" src="@routes.Assets.versioned("images/elty.jpg")">
                    <p class="post__author">Elty</p>
                }
            </div>
            <p class="post__title">@post.title</p>
            <div class="flexbox ff-wrap">
                @post.tags.getOrElse(Array.empty).map { tag =>
                    <p class="post__tag">@tag</p>
                    <!-- <a href="@routes.HomeController.byTags(tag)">@tag</a> -->
                }
            </div>
        </div>
    </a>
}

@main(id = "blog", title = "Lunatech's engineer blog") {
    <section class="p80-0">
        <div class="wrapper">
            <h2>Latest articles</h2>
            <p class="subtitle">Our most recent posts</p>
            <div class="grid">
                <div class="articles">

                </div>
            </div>
        </div>
    </section>
        
    <section class="p80-0 bg-gray">
        <div class="wrapper">
            <h2>All blog posts</h2>
            <p class="subtitle">Our different categories</p>

            <div id="post-list" class="post-list">
                @posts.map { post => @displayPost(post) }
            </div>

            @if(blogsPerPage != -1) {
                <div class="flexbox jc-c mgt-32">
                    <button class="btn btn__secondary" id="load">Load more</button>
                </div>
            }

            @helper.javascriptRouter("jsRoutes")(
                routes.javascript.Assets.versioned,
                routes.javascript.HomeController.byTags,
                routes.javascript.HomeController.byAuthor
            )
        </div>
    </section>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/axios/0.18.0/axios.js" integrity="sha256-lrZTgsdM1iVdRigETFOU8u8/BmLX1ysQ8bzrULbuVFU=" crossorigin="anonymous"></script>
    <script>
        // we will add this content, replace for anything you want to add
        document.addEventListener("DOMContentLoaded", function (event) {
            var btn = document.getElementById("load")
            var listPosts = document.getElementById("post-list")
            var page = 2

            // cross browser addEvent, today you can safely use just addEventListener
            function addEvent(obj, ev, fn) {
                if (obj.addEventListener) obj.addEventListener(ev, fn, false)
                else if (obj.attachEvent) obj.attachEvent("on" + ev, fn)
            }

            async function fetchPosts() {
                const posts = []
                let state = {
                    posts: [],
                    baseUrl: '/posts/',
                }
                const post = axios.get(`${state.baseUrl}?page=${page}`)
                posts.push(post)

                await axios.all(posts).then((response) => {
                    const postData = response.map(res => res.data)
                    state.posts = postData.flat()
                }).catch(e => console.log('error fetching posts: ', e))

                return state.posts
            }

            function displayPost(post) {
                const tagLinks = post.tags.map(tag => `<p class="post__tag">${tag}</p>`);
                var authorImg = "";
                if (post.author_img === "null") {
                    authorImg =
                        `
                            <img class="post__avatar" src="${jsRoutes.controllers.Assets.versioned("images/" + post.lang + ".png").url}">
                        `
                } else {
                    authorImg =
                        `
                            <img class="post__avatar" src="${post.author_img}" alt="author image" nopin="nopin">
                        `
                }
                return `<a class="post" href="${post.slug}">
                        <div class="post__cover">
                            <img src="${post.image_url}" onerror="this.src='https://lunatech.cdn.prismic.io/lunatech/c01fd6de48c3cdb8bda7247b0b94b84b14f3a488_kevin-horvat-1354011-unsplash.jpg';" alt=""/>
                        </div>
                        <div class="post__infos">
                            <div class="flexbox">
                                ${authorImg}
                                <p class="post__author">${post.author}<span></span>${post.publication_date})<span></span></p> 
                            </div>
                            <p class="post__title">${post.title}</p>
                            <div class="flexbox ff-wrap">
                                ${tagLinks.join(" ")}
                            </div>
                        </div>
                    </a>`
                ;
            }

            // this is the scroll event handler
            function loadContent() {
                // print relevant scroll info
                fetchPosts().then((posts) => {
                    page = page + 1;
                    if (posts.length === 0 || posts.length < @blogsPerPage) {
                        btn.remove();
                    }
                    for (const post of posts) {
                        listPosts.innerHTML += displayPost(post);
                    }
                })
            }

            // hook the scroll handler to scroll event
            addEvent(btn, "click", loadContent);
        });
    </script>
}
